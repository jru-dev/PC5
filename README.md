# üìö Sistema de Biblioteca Virtual

Un sistema web desarrollado en Laravel con Oracle Database que permite gestionar el cat√°logo de libros de una biblioteca con autenticaci√≥n personalizada y control de roles.

## üìã Caracter√≠sticas

- **Autenticaci√≥n personalizada** con Oracle Database y compatibilidad de contrase√±as
- **Gesti√≥n completa de libros** (CRUD)
- **Sistema de registro** de nuevos usuarios
- **Control de roles** (Bibliotecario/Usuario)
- **Dashboard con estad√≠sticas** en tiempo real
- **Interfaz responsive** con Bootstrap
- **Migraci√≥n autom√°tica** de contrase√±as legacy a formato seguro

## üöÄ Tecnolog√≠as Utilizadas

- **Backend:** Laravel 11.x
- **Base de Datos:** Oracle Database
- **Frontend:** Bootstrap 5.1.3
- **PHP:** 8.2+
- **Servidor Web:** Apache/Nginx
- **Autenticaci√≥n:** Sistema personalizado con Hash

## üìã Requisitos Previos

### Software Requerido

1. **PHP 8.2 o superior**
2. **Composer**
3. **Oracle Database** (11g o superior)
4. **Servidor Web** (Apache/Nginx)
5. **Git**

### Extensiones PHP Requeridas

- php-oci8
- php-mbstring
- php-xml
- php-curl
- php-zip

## üõ†Ô∏è Instalaci√≥n

### 1. Clonar el Repositorio

```bash
git clone https://github.com/jru-dev/PC5.git
cd biblioteca-virtual
```

### 2. Instalar Dependencias

```bash
composer install
```

### 3. Configurar el Archivo de Entorno

```bash
cp .env.example .env
```

Editar el archivo `.env` con tu configuraci√≥n:

```env
APP_NAME="Biblioteca Virtual"
APP_ENV=local
APP_DEBUG=true
APP_URL=http://localhost:8000

# Configuraci√≥n Oracle
DB_CONNECTION=oracle
DB_HOST=localhost
DB_PORT=1521
DB_DATABASE=XE
DB_USERNAME=tu_usuario_oracle
DB_PASSWORD=tu_password_oracle
DB_CHARSET=AL32UTF8

# Configuraci√≥n de Sesiones
SESSION_DRIVER=file
CACHE_DRIVER=file
QUEUE_CONNECTION=sync
```

### 4. Generar Clave de Aplicaci√≥n

```bash
php artisan key:generate
```

### 5. Configurar Oracle

#### Instalar Oracle Instant Client

**Windows:**
1. Descargar Oracle Instant Client desde el sitio oficial
2. Extraer en `C:\instantclient_XX_X`
3. Agregar la ruta al PATH del sistema

**Linux/Ubuntu:**
```bash
sudo apt-get install alien libaio1
# Descargar e instalar Oracle Instant Client
```

#### Instalar Extensi√≥n OCI8

**Con PECL:**
```bash
sudo pecl install oci8
```

**Activar en php.ini:**
```ini
extension=oci8
```

### 6. Configurar Base de Datos

#### Crear las Tablas

```sql
-- Tabla de usuarios (estructura actualizada)
CREATE TABLE usuarios (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    username VARCHAR2(50) UNIQUE NOT NULL,
    email VARCHAR2(100) UNIQUE NOT NULL,
    password VARCHAR2(255) NOT NULL,
    rol VARCHAR2(20) DEFAULT 'usuario' CHECK (rol IN ('bibliotecario', 'usuario')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabla de libros
CREATE TABLE libros (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    titulo VARCHAR2(200) NOT NULL,
    autor VARCHAR2(100) NOT NULL,
    isbn VARCHAR2(20),
    categoria VARCHAR2(50),
    disponible NUMBER(1) DEFAULT 1 CHECK (disponible IN (0,1)),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Crear secuencias si no se usa IDENTITY (para versiones Oracle m√°s antiguas)
-- CREATE SEQUENCE usuarios_seq START WITH 1 INCREMENT BY 1;
-- CREATE SEQUENCE libros_seq START WITH 1 INCREMENT BY 1;
```

#### Insertar Datos de Prueba

```sql
-- Usuarios de prueba (contrase√±as en texto plano - se migrar√°n autom√°ticamente)
INSERT INTO usuarios (username, email, password, rol) 
VALUES ('admin', 'admin@biblioteca.com', 'admin123', 'bibliotecario');

INSERT INTO usuarios (username, email, password, rol) 
VALUES ('usuario1', 'usuario1@ejemplo.com', '123456', 'usuario');

-- Libros de prueba
INSERT INTO libros (titulo, autor, isbn, categoria, disponible) 
VALUES ('Cien a√±os de soledad', 'Gabriel Garc√≠a M√°rquez', '978-0307474728', 'Literatura', 1);

INSERT INTO libros (titulo, autor, isbn, categoria, disponible) 
VALUES ('Don Quijote de la Mancha', 'Miguel de Cervantes', '978-8437604947', 'Cl√°sicos', 1);

INSERT INTO libros (titulo, autor, isbn, categoria, disponible) 
VALUES ('1984', 'George Orwell', '978-0451524935', 'Ficci√≥n', 0);

INSERT INTO libros (titulo, autor, isbn, categoria, disponible) 
VALUES ('El Principito', 'Antoine de Saint-Exup√©ry', '978-0156012195', 'Infantil', 1);

INSERT INTO libros (titulo, autor, isbn, categoria, disponible) 
VALUES ('La Odisea', 'Homero', '978-0140268867', 'Cl√°sicos', 1);

COMMIT;
```

### 7. Verificar Conexi√≥n

```bash
# Probar la conexi√≥n a Oracle
php artisan tinker
DB::connection('oracle')->select('SELECT 1 as test FROM dual');
```

### 8. Iniciar el Servidor

```bash
php artisan serve
```

Visita: `http://localhost:8000`

## üë• Usuarios de Prueba

| Usuario | Contrase√±a | Rol | Notas |
|---------|------------|-----|-------|
| admin | admin123 | bibliotecario | Usuario administrador completo |
| usuario1 | 123456 | usuario | Usuario de consulta |

**Nota:** Las contrase√±as se migrar√°n autom√°ticamente a formato seguro en el primer login.

## üîê Sistema de Autenticaci√≥n

### Caracter√≠sticas de Seguridad

- **Compatibilidad dual:** Soporta contrase√±as legacy (texto plano) y nuevas (encriptadas)
- **Migraci√≥n autom√°tica:** Las contrase√±as se actualizan autom√°ticamente al hacer login
- **Registro seguro:** Nuevos usuarios usan encriptaci√≥n Bcrypt desde el inicio
- **Validaci√≥n robusta:** Verificaci√≥n de usuarios √∫nicos por username y email

### Flujo de Autenticaci√≥n

1. Usuario ingresa credenciales
2. Sistema verifica formato de contrase√±a (legacy vs encriptada)
3. Si es legacy: compara directamente y actualiza a formato seguro
4. Si es encriptada: usa Hash::check() para verificaci√≥n
5. Establece sesi√≥n con datos del usuario y rol

## üìÅ Estructura del Proyecto

```
biblioteca-virtual/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ Http/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Controllers/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthController.php          # Autenticaci√≥n y registro
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LibroController.php         # Gesti√≥n de libros
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Auth/                       # Controladores Laravel Auth (legacy)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Middleware/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ OracleAuth.php              # Middleware personalizado
‚îú‚îÄ‚îÄ resources/
‚îÇ   ‚îî‚îÄ‚îÄ views/
‚îÇ       ‚îú‚îÄ‚îÄ auth/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ login.blade.php             # Formulario de login
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ register.blade.php          # Formulario de registro
‚îÇ       ‚îú‚îÄ‚îÄ libros/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ index.blade.php             # Lista de libros
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ create.blade.php            # Crear libro
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ show.blade.php              # Ver libro
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ edit.blade.php              # Editar libro
‚îÇ       ‚îî‚îÄ‚îÄ dashboard.blade.php             # Panel principal
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îî‚îÄ‚îÄ web.php                             # Rutas del sistema
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ database.php                        # Configuraci√≥n Oracle
‚îî‚îÄ‚îÄ bootstrap/
    ‚îî‚îÄ‚îÄ app.php                             # Middleware registration
```

## üîß Funcionalidades

### Para Usuarios
- ‚úÖ Registro de nueva cuenta
- ‚úÖ Iniciar sesi√≥n con migraci√≥n de contrase√±a
- ‚úÖ Ver cat√°logo de libros
- ‚úÖ Ver detalles de libros
- ‚úÖ Consultar estad√≠sticas del sistema

### Para Bibliotecarios
- ‚úÖ Todas las funciones de usuario
- ‚úÖ Agregar nuevos libros
- ‚úÖ Editar informaci√≥n de libros
- ‚úÖ Eliminar libros del cat√°logo
- ‚úÖ Cambiar estado de disponibilidad
- ‚úÖ Gesti√≥n completa del inventario

## üåü Caracter√≠sticas Especiales

### Sistema de Roles
- **Usuario:** Solo consulta y visualizaci√≥n
- **Bibliotecario:** Gesti√≥n completa del cat√°logo

### Dashboard Inteligente
- Estad√≠sticas en tiempo real
- Contadores de libros disponibles/prestados
- Porcentaje de disponibilidad
- Navegaci√≥n contextual seg√∫n rol

### Seguridad Avanzada
- Middleware personalizado para protecci√≥n de rutas
- Validaci√≥n de sesiones con Oracle
- Encriptaci√≥n autom√°tica de contrase√±as
- Protecci√≥n CSRF en formularios

## üêõ Soluci√≥n de Problemas

### Error: "This password does not use the Bcrypt algorithm"
Este error ocurre con cuentas legacy. **Soluci√≥n autom√°tica:** El sistema maneja ambos tipos de contrase√±a autom√°ticamente.

### Error: "Vite manifest not found"
```bash
# Instalar dependencias y compilar assets
npm install
npm run build
```

### Error: "Unsupported driver [oracle]"
```bash
# Verificar instalaci√≥n del paquete Oracle
composer show yajra/laravel-oci8

# Limpiar cach√© de configuraci√≥n
php artisan config:clear
php artisan cache:clear
```

### Error de conexi√≥n Oracle
1. Verificar que Oracle est√© ejecut√°ndose: `lsnrctl status`
2. Comprobar credenciales en `.env`
3. Verificar extensi√≥n OCI8: `php -m | grep oci8`
4. Probar conexi√≥n: `php artisan tinker` ‚Üí `DB::connection('oracle')->getPdo()`

### Error de permisos (Linux)
```bash
# Dar permisos necesarios
sudo chown -R www-data:www-data storage bootstrap/cache
chmod -R 775 storage bootstrap/cache
```

## üìä Base de Datos - Respaldo y Migraci√≥n

### Opci√≥n 1: Archivo SQL (Recomendado para desarrollo)
```sql
-- Exportar estructura y datos
SELECT 'CREATE TABLE ' || table_name || ' (' || 
       LISTAGG(column_name || ' ' || data_type || 
               CASE WHEN data_length IS NOT NULL THEN '(' || data_length || ')' END, 
               ', ') WITHIN GROUP (ORDER BY column_id) || 
       ');' as ddl
FROM user_tab_columns 
GROUP BY table_name;
```

### Opci√≥n 2: Oracle Data Pump (Recomendado para producci√≥n)
```bash
# Exportar esquema completo
expdp username/password@database directory=DATA_PUMP_DIR dumpfile=biblioteca.dmp schemas=tu_esquema

# Importar en servidor destino
impdp username/password@database directory=DATA_PUMP_DIR dumpfile=biblioteca.dmp schemas=tu_esquema
```

### Opci√≥n 3: Script de Migraci√≥n de Contrase√±as
Si necesitas migrar todas las contrase√±as de una vez (opcional):

```bash
# Agregar esta ruta temporal en routes/web.php (EJECUTAR SOLO UNA VEZ)
Route::get('/migrate-passwords', function () {
    $users = DB::connection('oracle')->select("SELECT username, password FROM usuarios");
    foreach ($users as $user) {
        if (!str_starts_with($user->password, '$2y$')) {
            $hashedPassword = Hash::make($user->password);
            DB::connection('oracle')->update(
                "UPDATE usuarios SET password = ? WHERE username = ?",
                [$hashedPassword, $user->username]
            );
        }
    }
    return "Contrase√±as migradas exitosamente";
});
```

## üß™ Testing

### Probar Funcionalidades B√°sicas
```bash
# Verificar conexi√≥n Oracle
php artisan route:list
curl http://localhost:8000/test-oracle

# Probar login
curl -X POST http://localhost:8000/login \
     -H "Content-Type: application/json" \
     -d '{"username":"admin","password":"admin123"}'
```

### Datos de Prueba Adicionales
```sql
-- Agregar m√°s libros para testing
INSERT INTO libros (titulo, autor, isbn, categoria, disponible) VALUES 
('Fahrenheit 451', 'Ray Bradbury', '978-1451673319', 'Ciencia Ficci√≥n', 1),
('El C√≥digo Da Vinci', 'Dan Brown', '978-0307474278', 'Thriller', 0),
('Orgullo y Prejuicio', 'Jane Austen', '978-0141439518', 'Romance', 1);
COMMIT;
```

## üöÄ Siguientes Pasos

### Funcionalidades Planificadas
- [ ] **M√≥dulo de pr√©stamos** con fechas de vencimiento
- [ ] **Sistema de reservas** para libros no disponibles
- [ ] **Reportes avanzados** (PDF/Excel)
- [ ] **B√∫squeda avanzada** con filtros m√∫ltiples
- [ ] **API REST** para integraciones
- [ ] **Notificaciones** por email
- [ ] **Historial de pr√©stamos** por usuario
- [ ] **Sistema de multas** autom√°tico

### Mejoras T√©cnicas
- [ ] **Tests automatizados** (PHPUnit)
- [ ] **Dockerizaci√≥n** del proyecto
- [ ] **CI/CD** con GitHub Actions
- [ ] **Cach√© Redis** para mejor rendimiento
- [ ] **Logs avanzados** con Monolog

## ü§ù Contribuir

1. Fork el proyecto
2. Crear una rama feature (`git checkout -b feature/nueva-funcionalidad`)
3. Commit los cambios (`git commit -m 'Agregar nueva funcionalidad'`)
4. Push a la rama (`git push origin feature/nueva-funcionalidad`)
5. Abrir un Pull Request

### Est√°ndares de C√≥digo
- Seguir PSR-12 para PHP
- Usar nombres descriptivos en espa√±ol para vistas y rutas
- Documentar funciones complejas
- Mantener controladores delgados

## üìù Licencia

Este proyecto est√° bajo la Licencia MIT - ver el archivo [LICENSE.md](LICENSE.md) para m√°s detalles.

## üìû Soporte

Si tienes problemas con la instalaci√≥n:

1. **Verifica requisitos:** PHP 8.2+, Oracle 11g+, extensi√≥n OCI8
2. **Revisa logs:** `storage/logs/laravel.log`
3. **Prueba conexi√≥n:** `php artisan tinker` ‚Üí `DB::connection('oracle')->select('SELECT 1 FROM dual')`
4. **Consulta la documentaci√≥n:** Secci√≥n de soluci√≥n de problemas

### Contacto
- **Email:** tu-email@ejemplo.com
- **GitHub Issues:** Para reportar bugs o solicitar features
- **Documentaci√≥n:** Wiki del repositorio

---

**¬°Gracias por usar el Sistema de Biblioteca Virtual!** üìö‚ú®

> *Desarrollado con ‚ù§Ô∏è usando Laravel y Oracle Database*